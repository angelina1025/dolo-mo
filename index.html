<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolo ERPç³»çµ±</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- XLSX Library (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- JSZip & FileSaver (ç”¨æ–¼æ‰“åŒ…å‚™ä»½) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- html2canvas (ç”¨æ–¼å°‡å ±è¡¨è½‰ç‚ºåœ–ç‰‡) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- React & ReactDOM (UMD ç‰ˆæœ¬ï¼Œæ”¯æ´ file:// ç›´æ¥é–‹å•Ÿ) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <style>
        /* ä¸€èˆ¬æ¨£å¼ */
        .icon-emoji { display: inline-block; width: 1.25rem; text-align: center; margin-right: 0.5rem; }
        
        /* éŒ¯èª¤è¨Šæ¯æ¨£å¼ */
        #error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; padding: 2rem; color: #dc2626; overflow: auto; }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ (A4 æœ€ä½³åŒ–) --- */
        @media print {
            @page {
                size: A4 portrait; /* å¼·åˆ¶ A4 ç›´å‘ */
                margin: 1.5cm;     /* è¨­å®šé‚Šç•Œ */
            }

            body {
                background: white;
                font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
                font-size: 12pt;
                color: black;
                -webkit-print-color-adjust: exact; /* ä¿ç•™èƒŒæ™¯è‰² (å¦‚æœæœ‰) */
                print-color-adjust: exact;
            }

            /* éš±è—ç¶²é ä»‹é¢å…ƒç´  (å´é‚Šæ¬„ã€èƒŒæ™¯ã€æŒ‰éˆ•ç­‰) */
            .print\:hidden, 
            .sidebar-container, 
            button, 
            .no-print {
                display: none !important;
            }

            /* é‡ç½® Modal æ¨£å¼ï¼Œä½¿å…¶æˆç‚ºæ–‡ä»¶æµçš„ä¸€éƒ¨åˆ† */
            .fixed.inset-0 {
                position: static !important;
                z-index: auto !important;
                background: white !important;
                padding: 0 !important;
                display: block !important;
                width: 100% !important;
                height: auto !important;
            }

            .bg-white.rounded-lg.shadow-2xl {
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: none !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }

            /* è¡¨æ ¼åˆ—å°å„ªåŒ– */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin-top: 10px;
                margin-bottom: 20px;
                font-size: 10pt; /* ç¸®å°å­—é«”ä»¥å®¹ç´æ›´å¤šæ¬„ä½ */
            }

            thead {
                display: table-header-group; /* æ›é æ™‚é‡è¤‡æ¨™é¡Œ */
                border-bottom: 2px solid #000;
            }

            tr {
                break-inside: avoid; /* ç›¡é‡ä¸åˆ‡æ–·åˆ— */
            }

            th, td {
                border: 1px solid #333 !important; /* å¼·åˆ¶é¡¯ç¤ºé‚Šæ¡† */
                padding: 6px 4px !important;
                text-align: left;
                color: #000 !important; /* å¼·åˆ¶é»‘è‰²æ–‡å­— */
            }

            th {
                background-color: #f3f4f6 !important; /* æ¨™é¡Œæ·ºç°åº• */
                font-weight: bold;
                text-align: center;
            }

            td.text-right { text-align: right; }
            td.text-center { text-align: center; }

            /* éš±è—æ²è»¸ */
            ::-webkit-scrollbar { display: none; }

            /* ç°½åæ¬„ä½æ’ç‰ˆ */
            .signature-section {
                margin-top: 2cm;
                display: flex !important;
                justify-content: space-between;
                break-inside: avoid;
            }
            
            .signature-box {
                border-top: 1px solid #000;
                width: 200px;
                text-align: center;
                padding-top: 8px;
                font-size: 12pt;
            }
            
            /* æ¨™é¡Œèˆ‡è³‡è¨Šå€ */
            .print-header {
                text-align: center;
                margin-bottom: 1.5cm;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
            }
            .print-header h1 {
                font-size: 18pt;
                font-weight: bold;
                margin-bottom: 5px;
            }
            .print-info-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                font-size: 12pt;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
    <div id="root" class="flex items-center justify-center h-screen text-gray-500">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <div id="error-overlay">
        <h1 class="text-2xl font-bold mb-4">ç³»çµ±ç™¼ç”ŸéŒ¯èª¤</h1>
        <pre id="error-message" class="bg-gray-100 p-4 rounded border border-red-200"></pre>
    </div>

    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const overlay = document.getElementById('error-overlay');
            const message = document.getElementById('error-message');
            overlay.style.display = 'block';
            message.textContent = `Error: ${msg}\nLine: ${lineNo}\nFile: ${url}`;
            return false;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const BONUS_RATIOS = {
            dept: 0.55, company: 0.45, coo: 0.30, admin: 0.10, marketing: 0.05,
            design: 0.05, tech: 0.05, opCost: 0.25, dividends: 0.15, reserve: 0.05
        };

        const DEPARTMENTS_CONFIG = [
            { id: 'coo', name: 'ç¸½ç‡Ÿé‹é•·', ratio: 30, key: 'coo' },
            { id: 'admin', name: 'æœƒè¨ˆè¡Œæ”¿&æ¥­å‹™æ´¾å·¥', ratio: 10, key: 'admin' },
            { id: 'marketing', name: 'ç³»çµ±ç¶­è­·&è¡ŒéŠ·ç®¡ç†', ratio: 5, key: 'marketing' },
            { id: 'design', name: 'ç¾ç·¨è¨­è¨ˆ&ç¤¾ç¾¤ç®¡ç†', ratio: 5, key: 'design' },
            { id: 'tech', name: 'æŠ€è¡“ä¸»ç®¡', ratio: 5, key: 'tech' }
        ];

        // --- Print Utility Function (New Window) ---
        const printReport = (title, metaInfo, tableHeaders, tableData, totalInfo, signatures) => {
            const printWindow = window.open('', '_blank');
            if (!printWindow) { alert('è«‹å…è¨±é–‹å•Ÿå½ˆè·³è¦–çª—ä»¥åˆ—å°å ±è¡¨'); return; }
            
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        @page { size: A4 portrait; margin: 1.5cm; }
                        body { font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif; padding: 20px; color: #000; font-size: 11pt; }
                        h1 { text-align: center; font-size: 20pt; margin: 0 0 5px 0; font-weight: 900; }
                        .subtitle { text-align: center; font-size: 10pt; color: #555; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #000; }
                        .meta-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12pt; }
                        .meta-label { font-weight: bold; }
                        
                        .total-section { border: 2px solid #000; padding: 10px 15px; margin: 15px 0; display: flex; justify-content: space-between; align-items: center; background-color: #f8f8f8; }
                        .total-label { font-weight: bold; font-size: 13pt; }
                        .total-value { font-weight: 900; font-size: 15pt; font-family: "Courier New", monospace; }
                        
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 10pt; }
                        th, td { border: 1px solid #444; padding: 6px 8px; vertical-align: middle; }
                        th { background-color: #eee; font-weight: bold; text-align: center; white-space: nowrap; }
                        
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        /* é‡‘é¡å°ˆç”¨å­—é«”ï¼šç­‰å¯¬ + æ•¸å­—å°é½Š */
                        .money { font-family: "Courier New", monospace; font-weight: bold; font-variant-numeric: tabular-nums; }
                        
                        .signatures { display: flex; justify-content: space-between; margin-top: 50px; page-break-inside: avoid; }
                        .sign-box { width: 200px; border-top: 1px solid #000; padding-top: 10px; text-align: center; font-size: 12pt; }
                        
                        @media print {
                            body { padding: 0; }
                            .total-section { background-color: white !important; -webkit-print-color-adjust: exact; }
                            th { background-color: #eee !important; -webkit-print-color-adjust: exact; }
                            /* é¿å…è¡¨æ ¼æ–·è£‚ */
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            thead { display: table-header-group; }
                            tfoot { display: table-footer-group; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div class="subtitle">åˆ—å°æ—¥æœŸ: ${new Date().toLocaleDateString()}</div>
                    
                    ${metaInfo.map(info => `<div class="meta-row"><span class="meta-label">${info.label}</span><span>${info.value}</span></div>`).join('')}
                    
                    ${totalInfo ? `
                    <div class="total-section">
                        <span class="total-label">${totalInfo.label}</span>
                        <span class="total-value">${totalInfo.value}</span>
                    </div>` : ''}
                    
                    <table>
                        <thead>
                            <tr>${tableHeaders.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${tableData.map(row => `
                                <tr>
                                    ${row.map((cell, i) => {
                                        let className = '';
                                        if (i === 0 || i === 1) className = 'text-center'; // Date and ID usually center
                                        else if (i === 4 && row.length === 6 && (String(cell).includes('%') || String(cell).includes('$'))) className = 'text-center'; // Ratio
                                        else if (i >= row.length - 1 || i === 3) className = 'text-right money'; // Last column and Amount is money
                                        return `<td class="${className}">${cell}</td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="signatures">
                        ${signatures.map(s => `<div class="sign-box">${s}</div>`).join('')}
                    </div>
                    
                    <script>
                        // è‡ªå‹•åˆ—å°
                        window.onload = () => { setTimeout(() => window.print(), 500); }
                    <\/script>
                </body>
                </html>
            `;
            printWindow.document.write(html);
            printWindow.document.close();
        };

        // --- Utility Functions ---
        const loadXLSX = () => {
            return new Promise((resolve) => {
                if (window.XLSX) { resolve(window.XLSX); return; }
                const check = setInterval(() => {
                    if (window.XLSX) { clearInterval(check); resolve(window.XLSX); }
                }, 100);
            });
        };

        const formatExcelDate = (input) => {
            if (!input) return '';
            if (input instanceof Date) {
                if (isNaN(input.getTime())) return '';
                const year = input.getFullYear();
                const month = String(input.getMonth() + 1).padStart(2, '0');
                const day = String(input.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            if (typeof input === 'number') {
                const date = new Date(Math.round((input - 25569) * 86400 * 1000));
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            if (typeof input === 'string') {
                const cleanInput = input.trim();
                const date = new Date(cleanInput);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                return input;
            }
            return '';
        };

        const getFuzzyValue = (row, ...candidates) => {
            const keys = Object.keys(row);
            for (const candidate of candidates) {
                if (row[candidate] !== undefined) return row[candidate];
                const trimKey = keys.find(k => k.trim() === candidate);
                if (trimKey && row[trimKey] !== undefined) return row[trimKey];
                const fuzzyKey = keys.find(k => k.includes(candidate));
                if (fuzzyKey && row[fuzzyKey] !== undefined) return row[fuzzyKey];
            }
            return ''; 
        };

        // --- Login Component ---
        const Login = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                // Hardcoded credentials as requested
                if (email === 'artemis19981025@gmail.com' && password === 'artemis19981025') {
                    onLogin();
                } else {
                    setError('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 font-sans">
                    <div className="bg-white p-10 rounded-xl shadow-2xl max-w-md w-full border border-gray-200">
                        <div className="text-center mb-8">
                            <span className="text-5xl mb-4 block">ğŸ”’</span>
                            <h2 className="text-2xl font-bold text-gray-800">Dolo ERP ç³»çµ±ç™»å…¥</h2>
                            <p className="text-gray-500 mt-2 text-sm">è«‹è¼¸å…¥æˆæ¬Šå¸³è™Ÿå¯†ç¢¼ä»¥å­˜å–ç³»çµ±</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å¸³è™Ÿ (Email)</label>
                                <input 
                                    type="email" 
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                    placeholder="name@example.com"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                                <input 
                                    type="password" 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                    required
                                />
                            </div>
                            {error && <div className="text-red-500 text-sm text-center bg-red-50 p-3 rounded border border-red-100 animate-pulse">{error}</div>}
                            <button 
                                type="submit" 
                                className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                            >
                                ç™»å…¥ç³»çµ±
                            </button>
                        </form>
                        <div className="mt-6 text-center text-xs text-gray-400">
                            &copy; Dolo ERP System. All rights reserved.
                        </div>
                    </div>
                </div>
            );
        };

        // --- Components ---

        const Sidebar = ({ currentView, setCurrentView, isCollapsed, setIsCollapsed }) => {
            const menuItems = [
                { id: 'process', label: 'æ´¾å·¥çµç®—æµç¨‹', icon: 'ğŸ“‹' },
                { id: 'task_management', label: 'æœ¬æ‰¹ä»»å‹™ç®¡ç†', icon: 'ğŸ“„' },
                { id: 'department_management', label: 'æœ¬æ‰¹éƒ¨é–€å ±è¡¨', icon: 'ğŸ¢' },
                { id: 'shareholder_management', label: 'è‚¡æ±ç®¡ç†', icon: 'ğŸ‘¥' },
                { id: 'settings_sales', label: 'æ¥­å‹™å–®ä½ç®¡ç†', icon: 'ğŸ’¼' },
                { id: 'settings_construction', label: 'æ–½å·¥å–®ä½ç®¡ç†', icon: 'ğŸ‘·' },
            ];

            return (
                <div className="sidebar-container bg-gray-900 text-white transition-all duration-300 flex flex-col h-screen fixed left-0 top-0 z-50 shadow-xl print:hidden" style={{ width: isCollapsed ? '5rem' : '16rem' }}>
                    <div className="h-16 flex items-center justify-center border-b border-gray-800 bg-gray-900">
                        {isCollapsed ? <span className="text-2xl">ğŸ—„ï¸</span> : 
                            <div className="flex items-center px-4"><span className="text-2xl mr-2">ğŸ—„ï¸</span><span className="font-bold text-lg tracking-wider">Dolo ERPç³»çµ±</span></div>}
                    </div>
                    <div className="flex-1 py-6 space-y-2 overflow-y-auto">
                        {menuItems.map(item => (
                            <button key={item.id} onClick={() => setCurrentView(item.id)} className={`w-full flex items-center px-6 py-3 transition-colors relative group ${currentView === item.id ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}>
                                <span className={`text-xl ${isCollapsed ? 'mx-auto' : 'mr-3'}`}>{item.icon}</span>
                                {!isCollapsed && <span className="text-sm font-medium whitespace-nowrap">{item.label}</span>}
                                {isCollapsed && <div className="absolute left-full ml-2 px-2 py-1 bg-gray-800 text-xs rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50 pointer-events-none">{item.label}</div>}
                            </button>
                        ))}
                    </div>
                    <button onClick={() => setIsCollapsed(!isCollapsed)} className="h-12 border-t border-gray-800 flex items-center justify-center hover:bg-gray-800 transition-colors">
                        {isCollapsed ? <span>â–¶ï¸</span> : <span>â—€ï¸</span>}
                    </button>
                </div>
            );
        };

        const DepartmentManager = ({ currentData }) => {
            const [selectedReportItem, setSelectedReportItem] = useState(null);
            const reportData = currentData || [];

            const calculateStats = (dept) => {
                const ratioDecimal = BONUS_RATIOS[dept.key] || (dept.ratio / 100);
                const totalBonus = reportData.filter(r => r.selected).reduce((acc, job) => {
                    const turnover = job.financials?.turnover || 0;
                    return acc + Math.round(turnover * ratioDecimal);
                }, 0);
                return { total: totalBonus, count: reportData.filter(r => r.selected).length, jobs: reportData.filter(r => r.selected) };
            };

            const handlePrintReport = (dept, stats) => {
                // æº–å‚™åˆ—å°è³‡æ–™
                const title = "dolo ERPç³»çµ± - éƒ¨é–€åˆ†ç´…å ±è¡¨";
                const metaInfo = [
                    { label: "éƒ¨é–€åç¨±ï¼š", value: dept.name },
                    { label: "åˆ†ç´…æ¯”ä¾‹ï¼š", value: `${dept.ratio}%` }
                ];
                const tableHeaders = ["æ—¥æœŸ", "ä»»å‹™ç·¨è™Ÿ", "ä»»å‹™åˆ†é¡", "è©²æ¡ˆç‡Ÿæ¥­é¡", "åˆ†ç´…é‡‘é¡"];
                
                const tableData = stats.jobs.map(job => {
                    const turnover = job.financials?.turnover || 0;
                    const ratioDecimal = BONUS_RATIOS[dept.key] || (dept.ratio / 100);
                    const bonus = Math.round(turnover * ratioDecimal);
                    return [
                        job.date,
                        job.id,
                        job.category || job.customerName, // è‹¥ç„¡åˆ†é¡å‰‡é¡¯ç¤ºå®¢æˆ¶(fallback)
                        `$${turnover.toLocaleString()}`,
                        `$${bonus.toLocaleString()}`
                    ];
                });

                const totalInfo = { label: "æœ¬æœŸæ‡‰é ˜åˆ†ç´…ç¸½é¡", value: `$${stats.total.toLocaleString()}` };
                const signatures = ["æœƒè¨ˆç°½ç« ", "éƒ¨é–€ä¸»ç®¡ç°½ç« "];

                printReport(title, metaInfo, tableHeaders, tableData, totalInfo, signatures);
            };

            return (
                <div className="p-8 animate-in fade-in slide-in-from-bottom-4">
                    <div className="flex justify-between items-center mb-8 print:hidden">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center"><span className="mr-2">ğŸ¢</span>éƒ¨é–€åˆ†ç´…ç®¡ç†</h2>
                        <div className="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">åŸºæ–¼ç•¶å‰åŒ¯å…¥è³‡æ–™</div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[400px]">
                        <div className="p-6 border-b bg-gray-50 flex justify-between items-center print:hidden">
                            <h3 className="text-lg font-bold text-gray-800 flex items-center"><span className="mr-2">ğŸ“Š</span>éƒ¨é–€åˆ†ç´…é è¦½å ±è¡¨</h3>
                            <div className="text-sm text-gray-500">çµ±è¨ˆç¯„åœï¼šç•¶å‰åŒ¯å…¥ä¸”å‹¾é¸çš„ä»»å‹™ ({reportData.filter(r => r.selected).length} ç­†)</div>
                        </div>
                        {reportData.length === 0 ? <div className="p-20 text-center text-gray-500">è«‹å…ˆåŒ¯å…¥ Excel è³‡æ–™</div> : (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-white"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">éƒ¨é–€åç¨±</th><th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">åˆ†ç´…ä½”æ¯”</th><th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">é è¨ˆåˆ†ç´…é‡‘é¡</th><th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase print:hidden">æ˜ç´°</th></tr></thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {DEPARTMENTS_CONFIG.map(dept => {
                                            const stats = calculateStats(dept);
                                            return (
                                                <tr key={dept.id} className="hover:bg-gray-50">
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{dept.name}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">{dept.ratio}%</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-green-600">${stats.total.toLocaleString()}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium print:hidden">
                                                        <button onClick={() => setSelectedReportItem({ ...dept, stats })} className="text-blue-600 hover:text-blue-900 flex items-center justify-center mx-auto mr-2"><span className="mr-1">ğŸ”</span> é è¦½</button>
                                                        <button onClick={() => handlePrintReport(dept, stats)} className="text-gray-600 hover:text-gray-900 flex items-center justify-center mx-auto"><span className="mr-1">ğŸ–¨ï¸</span> åˆ—å°</button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                    {/* Modal for Quick Preview only, actual print is handled by new window */}
                    {selectedReportItem && (
                        <div className="fixed inset-0 z-[200] bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-2xl max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-start mb-8 print:hidden"><h2 className="text-xl font-bold">é è¦½ï¼š{selectedReportItem.name}</h2><button onClick={() => setSelectedReportItem(null)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200">âŒ</button></div>
                                <table>
                                    <thead><tr><th>æ—¥æœŸ</th><th>ä»»å‹™ç·¨è™Ÿ</th><th>ä»»å‹™åˆ†é¡</th><th className="text-right">è©²æ¡ˆç‡Ÿæ¥­é¡</th><th className="text-right">åˆ†ç´…é‡‘é¡</th></tr></thead>
                                    <tbody>
                                        {selectedReportItem.stats.jobs.map(job => (
                                            <tr key={job.id}>
                                                <td>{job.date}</td><td>{job.id}</td><td>{job.category}</td>
                                                <td className="text-right">${(job.financials?.turnover||0).toLocaleString()}</td>
                                                <td className="text-right font-bold">${Math.round((job.financials?.turnover||0) * (BONUS_RATIOS[selectedReportItem.key] || selectedReportItem.ratio/100)).toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div className="mt-4 flex justify-end">
                                    <button onClick={() => handlePrintReport(selectedReportItem, selectedReportItem.stats)} className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center"><span className="mr-2">ğŸ–¨ï¸</span> æ­£å¼åˆ—å°</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const GenericManager = ({ title, icon, collectionName, fields, enableBatchImport, currentReportData, localData, setLocalData }) => {
            const [viewMode, setViewMode] = useState('list');
            const [data, setData] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [isBatchImporting, setIsBatchImporting] = useState(false);
            const [editId, setEditId] = useState(null);
            const [formData, setFormData] = useState({});
            const [batchText, setBatchText] = useState('');
            const [parsedBatchData, setParsedBatchData] = useState([]);
            const [selectedReportItem, setSelectedReportItem] = useState(null);

            // å„ªå…ˆä½¿ç”¨ localData
            useEffect(() => {
                if (localData) {
                    setData(localData);
                } else {
                    setData([]);
                }
            }, [localData]);

            const reportData = currentReportData || [];

            const openAdd = () => {
                const initialData = {};
                fields.forEach(f => initialData[f.key] = f.defaultValue !== undefined ? f.defaultValue : '');
                setFormData(initialData); setEditId(null); setIsEditing(true);
            };

            const openEdit = (item) => {
                const currentData = {};
                fields.forEach(f => currentData[f.key] = item[f.key]);
                setFormData(currentData); setEditId(item.id); setIsEditing(true);
            };

            const handleSave = async () => {
                if (!formData[fields[0].key]) { alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½'); return; }
                
                const payload = { ...formData, updatedAt: new Date() };
                
                if (localData && setLocalData) {
                    if (editId) {
                        setLocalData(localData.map(item => item.id === editId ? { ...item, ...payload } : item));
                    } else {
                        setLocalData([...localData, { ...payload, id: `temp_${Date.now()}`, createdAt: new Date() }]);
                    }
                }
                setIsEditing(false);
            };

            const handleDelete = async (id) => { 
                if (window.confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
                    if (localData && setLocalData) {
                        setLocalData(localData.filter(item => item.id !== id));
                    }
                }
            };

            const handleParseBatch = () => {
                if (!batchText) return;
                let parsed = [];
                const regex = /([^\d\s%]+)\s*(\d+)\s*([\d\.]+)%/g;
                let match;
                const cleanText = batchText.replace(/æŠ•è³‡äºº|æŠ•è³‡è‚¡æ•¸|åˆ†ç´…ç™¾åˆ†æ¯”|å§“å|è‚¡æ•¸/g, '').trim();
                while ((match = regex.exec(cleanText)) !== null) {
                    if (match[1].trim()) parsed.push({ name: match[1].trim(), shares: parseFloat(match[2]), ratio: parseFloat(match[3]), role: '' });
                }
                if (parsed.length === 0) {
                    parsed = batchText.split('\n').filter(l => l.trim() !== '' && !l.includes('æŠ•è³‡äºº')).map(line => {
                        const parts = line.split(/[\t\s]+/).filter(p => p.trim() !== '');
                        const name = parts.find(p => isNaN(parseFloat(p)));
                        const numbers = parts.filter(p => !isNaN(parseFloat(p.replace('%', ''))));
                        if (name && numbers.length >= 2) return { name, shares: parseFloat(numbers[0]), ratio: parseFloat(numbers[1].replace('%', '')), role: '' };
                        return null;
                    }).filter(i => i);
                }
                setParsedBatchData(parsed);
            };

            const saveBatchData = async () => {
                const newItems = parsedBatchData.map(item => ({ ...item, id: `batch_${Date.now()}_${Math.random()}`, createdAt: new Date() }));
                if (localData && setLocalData) {
                    setLocalData([...localData, ...newItems]);
                    setIsBatchImporting(false); setBatchText(''); setParsedBatchData([]); alert(`æˆåŠŸåŒ¯å…¥ ${newItems.length} ç­†è³‡æ–™`);
                }
            };

            const calculateReportStats = (item) => {
                let totalIncome = 0;
                let relatedJobs = [];
                const activeJobs = reportData.filter(r => r.selected);

                if (collectionName === 'shareholders') {
                    const globalPool = activeJobs.reduce((acc, job) => acc + Math.round((job.financials?.turnover || 0) * 0.15), 0);
                    const myDividend = Math.round(globalPool * (parseFloat(item.ratio) / 100));
                    return { total: myDividend, count: activeJobs.length, label: 'æ‡‰é ˜åˆ†ç´…', jobs: activeJobs };
                } 
                if (collectionName === 'sales_units') {
                    relatedJobs = activeJobs.filter(j => j.salesUnitId === item.id);
                    totalIncome = relatedJobs.reduce((acc, job) => acc + (job.financials?.salesCost || 0), 0);
                    return { total: totalIncome, count: relatedJobs.length, label: 'æ¥­å‹™åˆ†æ½¤', jobs: relatedJobs };
                } 
                if (collectionName === 'construction_units') {
                    relatedJobs = activeJobs.filter(j => j.constructionUnitId === item.id);
                    totalIncome = relatedJobs.reduce((acc, job) => acc + (job.financials?.constructionCost || 0), 0);
                    return { total: totalIncome, count: relatedJobs.length, label: 'æ–½å·¥è²»ç”¨', jobs: relatedJobs };
                }
                return { total: 0, count: 0 };
            };

            const handlePrintReport = (item, stats) => {
                let title = "dolo ERPç³»çµ± - çµç®—å ±è¡¨";
                let metaInfo = [{ label: "å°è±¡ï¼š", value: item.name }];
                let signatures = ["ç¶“æ‰‹äººç°½ç« ", "é ˜æ¬¾äººç°½ç« "];
                let colName = "é‡‘é¡";
                let isUnitReport = false;

                if (collectionName === 'shareholders') {
                    title = "dolo ERPç³»çµ± - è‚¡æ±åˆ†ç´…å ±è¡¨";
                    metaInfo.push({ label: "æŒè‚¡æ¯”ä¾‹ï¼š", value: `${item.ratio}%` });
                    colName = "å€‹äººåˆ†ç´…";
                } else if (collectionName === 'sales_units') {
                    title = "dolo ERPç³»çµ± - æ¥­å‹™åˆ†æ½¤å ±è¡¨";
                    colName = "æ¥­å‹™åˆ†æ½¤";
                    isUnitReport = true;
                } else if (collectionName === 'construction_units') {
                    title = "dolo ERPç³»çµ± - æ–½å·¥è²»ç”¨å ±è¡¨";
                    colName = "æ–½å·¥è²»ç”¨";
                    isUnitReport = true;
                }

                let tableHeaders = [];
                if (isUnitReport) {
                    tableHeaders = ["æ—¥æœŸ", "ä»»å‹™ç·¨è™Ÿ", "ä»»å‹™åˆ†é¡", "ç¸½é‡‘é¡", "åˆ†ç´…æ¯”ä¾‹", colName];
                } else {
                    tableHeaders = ["æ—¥æœŸ", "ä»»å‹™ç·¨è™Ÿ", "ä»»å‹™åˆ†é¡", "è©²æ¡ˆç‡Ÿæ¥­é¡", colName];
                }

                const tableData = stats.jobs.map(job => {
                    const turnover = job.financials?.turnover || 0;
                    let value = 0;
                    
                    if (collectionName === 'shareholders') {
                        const pool = Math.round(turnover * BONUS_RATIOS.dividends);
                        const ratio = parseFloat(item.ratio) || 0;
                        value = Math.round(pool * (ratio / 100));
                        return [
                            job.date,
                            job.id,
                            job.category || job.customerName,
                            `$${turnover.toLocaleString()}`,
                            `$${value.toLocaleString()}`
                        ];
                    } else {
                        // Units
                        let ratio = 0;
                        if (collectionName === 'sales_units') {
                            value = job.financials?.salesCost;
                            ratio = job.salesRatio;
                        } else {
                            value = job.financials?.constructionCost;
                            ratio = job.constructionRatio;
                        }
                        return [
                            job.date,
                            job.id,
                            job.category || job.customerName,
                            `$${job.amount.toLocaleString()}`, // Using job.amount (ç¸½é‡‘é¡) instead of turnover
                            `${ratio}%`,
                            `$${(value || 0).toLocaleString()}`
                        ];
                    }
                });

                const totalInfo = { label: "ç´¯è¨ˆç¸½é‡‘é¡", value: `$${stats.total.toLocaleString()}` };
                
                printReport(title, metaInfo, tableHeaders, tableData, totalInfo, signatures);
            };

            return (
                <div className="p-8 animate-in fade-in slide-in-from-bottom-4">
                    <div className="flex justify-between items-center mb-8 print:hidden">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center"><span className="mr-2 text-2xl">{icon}</span>{title}</h2>
                        <div className="flex space-x-3 bg-gray-100 p-1 rounded-lg">
                            <button onClick={() => setViewMode('list')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${viewMode === 'list' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>åˆ—è¡¨ç®¡ç†</button>
                            <button onClick={() => setViewMode('report')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${viewMode === 'report' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>ç¸½åˆ†ç´…å ±è¡¨</button>
                        </div>
                    </div>

                    {viewMode === 'list' && (
                        <>
                            <div className="flex justify-end mb-4 print:hidden">
                                <div className="flex space-x-3">
                                    {enableBatchImport && <button onClick={() => setIsBatchImporting(true)} className="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-md"><span className="mr-2">ğŸ“‚</span> æ‰¹æ¬¡åŒ¯å…¥</button>}
                                    <button onClick={openAdd} className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md"><span className="mr-2">â•</span> æ–°å¢</button>
                                </div>
                            </div>
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden print:hidden">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50"><tr>{fields.map(f => <th key={f.key} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{f.label}</th>)}<th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th></tr></thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {data.map(item => (
                                            <tr key={item.id} className="hover:bg-gray-50">
                                                {fields.map(f => <td key={f.key} className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{f.type === 'boolean' ? (item[f.key] ? 'æ˜¯' : 'å¦') : item[f.key]}</td>)}
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onClick={() => openEdit(item)} className="text-indigo-600 hover:text-indigo-900 mr-4">âœï¸</button><button onClick={() => handleDelete(item.id)} className="text-red-600 hover:text-red-900">ğŸ—‘ï¸</button></td>
                                            </tr>
                                        ))}
                                        {data.length === 0 && <tr><td colSpan={fields.length + 1} className="px-6 py-10 text-center text-gray-500">å°šç„¡è³‡æ–™ (è«‹å…ˆåŒ¯å…¥ Excel)</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </>
                    )}

                    {viewMode === 'report' && (
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[400px]">
                            <div className="p-6 border-b bg-gray-50 flex justify-between items-center print:hidden"><h3 className="text-lg font-bold text-gray-800 flex items-center"><span className="mr-2">ğŸ“Š</span>æœ¬æ‰¹æ¬¡çµç®—å ±è¡¨</h3><div className="text-sm text-gray-500">å…±çµ±è¨ˆ {reportData.filter(r => r.selected).length} ç­†å·²å‹¾é¸ä»»å‹™</div></div>
                            {reportData.length === 0 ? <div className="p-20 text-center text-gray-500">è«‹å…ˆåŒ¯å…¥ Excel è³‡æ–™</div> : (
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-white">
                                            <tr>
                                                <th>æ—¥æœŸ</th>
                                                <th>ä»»å‹™ç·¨è™Ÿ</th>
                                                <th>ä»»å‹™åˆ†é¡</th>
                                                {(collectionName === 'sales_units' || collectionName === 'construction_units') ? (
                                                    <>
                                                        <th className="text-right">ç¸½é‡‘é¡</th>
                                                        <th className="text-center">åˆ†ç´…æ¯”ä¾‹</th>
                                                        <th className="text-right">{collectionName === 'sales_units' ? 'æ¥­å‹™åˆ†æ½¤' : 'æ–½å·¥è²»ç”¨'}</th>
                                                    </>
                                                ) : (
                                                    <>
                                                        <th className="text-right">è©²æ¡ˆç‡Ÿæ¥­é¡</th>
                                                        <th className="text-right">{collectionName === 'shareholders' ? 'å€‹äººåˆ†ç´…' : 'åˆ†ç´…é‡‘é¡'}</th>
                                                    </>
                                                )}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {data.map(item => {
                                                const stats = calculateReportStats(item);
                                                return (
                                                    <tr key={item.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.name}</td>
                                                        {collectionName === 'shareholders' && <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">{item.ratio}%</td>}
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">{stats.label} {collectionName !== 'shareholders' && `(${stats.count} ç­†)`}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-green-600">${stats.total.toLocaleString()}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium print:hidden">
                                                            <button onClick={() => setSelectedReportItem({ ...item, stats })} className="text-blue-600 hover:text-blue-900 flex items-center justify-center mx-auto mr-2"><span className="mr-1">ğŸ”</span> é è¦½</button>
                                                            <button onClick={() => handlePrintReport(item, stats)} className="text-gray-600 hover:text-gray-900 flex items-center justify-center mx-auto"><span className="mr-1">ğŸ–¨ï¸</span> åˆ—å°</button>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Preview Modal */}
                    {selectedReportItem && (
                        <div className="fixed inset-0 z-[200] bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-2xl max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-start mb-8 print:hidden"><h2 className="text-xl font-bold">é è¦½ï¼š{selectedReportItem.name}</h2><button onClick={() => setSelectedReportItem(null)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200">âŒ</button></div>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>æ—¥æœŸ</th>
                                            <th>ä»»å‹™ç·¨è™Ÿ</th>
                                            <th>ä»»å‹™åˆ†é¡</th>
                                            {(collectionName === 'sales_units' || collectionName === 'construction_units') ? (
                                                <>
                                                    <th className="text-right">ç¸½é‡‘é¡</th>
                                                    <th className="text-center">åˆ†ç´…æ¯”ä¾‹</th>
                                                    <th className="text-right">{collectionName === 'sales_units' ? 'æ¥­å‹™åˆ†æ½¤' : 'æ–½å·¥è²»ç”¨'}</th>
                                                </>
                                            ) : (
                                                <>
                                                    <th className="text-right">è©²æ¡ˆç‡Ÿæ¥­é¡</th>
                                                    <th className="text-right">{collectionName === 'shareholders' ? 'å€‹äººåˆ†ç´…' : 'åˆ†ç´…é‡‘é¡'}</th>
                                                </>
                                            )}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {selectedReportItem.stats.jobs.map(job => {
                                            const turnover = job.financials?.turnover || 0;
                                            const isUnit = collectionName === 'sales_units' || collectionName === 'construction_units';
                                            let value = 0;
                                            let ratio = 0;

                                            if (collectionName === 'shareholders') {
                                                const pool = Math.round(turnover * BONUS_RATIOS.dividends);
                                                const r = parseFloat(selectedReportItem.ratio) || 0;
                                                value = Math.round(pool * (r / 100));
                                            } else if (collectionName === 'sales_units') {
                                                value = job.financials?.salesCost;
                                                ratio = job.salesRatio;
                                            } else {
                                                value = job.financials?.constructionCost;
                                                ratio = job.constructionRatio;
                                            }
                                            
                                            return (
                                                <tr key={job.id}>
                                                    <td>{job.date}</td><td>{job.id}</td><td>{job.category || job.customerName}</td>
                                                    
                                                    {isUnit ? (
                                                        <>
                                                            <td className="text-right">${job.amount.toLocaleString()}</td>
                                                            <td className="text-center">{ratio}%</td>
                                                            <td className="text-right font-bold">${(value||0).toLocaleString()}</td>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <td className="text-right">${turnover.toLocaleString()}</td>
                                                            <td className="text-right font-bold">${(value||0).toLocaleString()}</td>
                                                        </>
                                                    )}
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                                <div className="mt-4 flex justify-end">
                                    <button onClick={() => handlePrintReport(selectedReportItem, selectedReportItem.stats)} className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center"><span className="mr-2">ğŸ–¨ï¸</span> æ­£å¼åˆ—å°</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isEditing && (
                        <div className="fixed inset-0 z-[100] bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 print:hidden">
                            <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                                <h3 className="text-lg font-medium text-gray-900 mb-4">{editId ? 'ç·¨è¼¯' : 'æ–°å¢'}</h3>
                                <div className="space-y-4">
                                    {fields.map(f => (
                                        <div key={f.key}><label className="block text-sm font-medium text-gray-700">{f.label} {f.required && <span className="text-red-500">*</span>}</label>
                                            {f.type === 'boolean' ? (<div className="mt-1 flex items-center"><input type="checkbox" checked={formData[f.key] || false} onChange={e => setFormData({...formData, [f.key]: e.target.checked})} className="h-4 w-4 text-blue-600 rounded"/><span className="ml-2 text-sm text-gray-500">å‹¾é¸ä»£è¡¨ã€Œæ˜¯ã€</span></div>) : (<input type={f.type || 'text'} value={formData[f.key] !== undefined ? formData[f.key] : ''} onChange={e => setFormData({...formData, [f.key]: e.target.value})} placeholder={f.placeholder} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 sm:text-sm"/>)}
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-6 flex justify-end space-x-3"><button onClick={() => setIsEditing(false)} className="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100">å–æ¶ˆ</button><button onClick={handleSave} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">å„²å­˜</button></div>
                            </div>
                        </div>
                    )}

                    {isBatchImporting && (
                        <div className="fixed inset-0 z-[200] bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 print:hidden">
                            <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 h-3/4 flex flex-col relative">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-gray-900">æ‰¹æ¬¡åŒ¯å…¥è‚¡æ±</h3>
                                    <button onClick={() => setIsBatchImporting(false)}>âŒ</button>
                                </div>
                                <div className="mb-4 bg-blue-50 p-3 rounded text-sm text-blue-800">æ”¯æ´æ ¼å¼ï¼šExcel è¡¨æ ¼è¤‡è£½ã€æˆ–æ–‡å­—è²¼ä¸Š (å¦‚ï¼šç°¡å­è»’610.0%...)ã€‚<br/>ç³»çµ±å°‡è‡ªå‹•éæ¿¾ã€ŒæŠ•è³‡äººã€æŠ•è³‡è‚¡æ•¸ã€ç­‰æ¨™é¡Œå­—çœ¼ã€‚</div>
                                <textarea className="w-full flex-1 border rounded p-2 font-mono text-sm mb-4" placeholder="è«‹åœ¨æ­¤è²¼ä¸Š..." value={batchText} onChange={e => setBatchText(e.target.value)}/>
                                <div className="flex justify-end space-x-2 mb-4"><button onClick={handleParseBatch} className="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-900">è§£æå…§å®¹</button></div>
                                {parsedBatchData.length > 0 && (
                                    <div className="flex-1 overflow-auto border rounded mb-4">
                                        <table className="min-w-full divide-y divide-gray-200 text-sm">
                                            <thead className="bg-gray-50 sticky top-0"><tr><th className="px-4 py-2 text-left">å§“å</th><th className="px-4 py-2 text-right">è‚¡æ•¸</th><th className="px-4 py-2 text-right">%</th></tr></thead>
                                            <tbody className="divide-y divide-gray-200">{parsedBatchData.map((row, i) => (<tr key={i}><td className="px-4 py-2">{row.name}</td><td className="px-4 py-2 text-right">{row.shares}</td><td className="px-4 py-2 text-right">{row.ratio}%</td></tr>))}</tbody>
                                        </table>
                                    </div>
                                )}
                                <div className="flex justify-end space-x-3 border-t pt-4"><button onClick={() => setIsBatchImporting(false)} className="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100">å–æ¶ˆ</button><button onClick={saveBatchData} disabled={parsedBatchData.length === 0} className="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50">ç¢ºèªåŒ¯å…¥</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TaskManager = ({ constructionUnits, salesUnits, tasks, setTasks }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [currentTask, setCurrentTask] = useState(null);

            const handleEdit = (task) => { setCurrentTask({ ...task }); setIsEditing(true); };
            
            const recalculateTaskFinancials = (task) => {
                const amount = Number(task.amount);
                const cUnit = constructionUnits.find(u => u.id === task.constructionUnitId) || { name: task.constructionUnitName }; 
                const sUnit = salesUnits.find(u => u.id === task.salesUnitId) || { name: task.salesUnitName };
                let salesCost = (sUnit.name === 'doloåœ˜éšŠ') ? 0 : Math.round(amount * (task.salesRatio / 100));
                let constructionCost = (cUnit.name === 'doloåœ˜éšŠ') ? Math.round(amount * 0.40) : Math.round(amount * (task.constructionRatio / 100));
                const turnover = amount - salesCost - constructionCost;
                return { salesCost, constructionCost, turnover, isDoloConstruction: cUnit.name === 'doloåœ˜éšŠ', deptBonus: Math.round(turnover * BONUS_RATIOS.dept), companyFunds: Math.round(turnover * BONUS_RATIOS.company) };
            };

            const handleSave = () => {
                if (!currentTask) return;
                const newFinancials = recalculateTaskFinancials(currentTask);
                const updatedTasks = tasks.map(t => t.id === currentTask.id ? { ...t, ...currentTask, financials: newFinancials, amount: Number(currentTask.amount) } : t);
                setTasks(updatedTasks);
                setIsEditing(false);
            };

            const handleDelete = (id) => { 
                if (confirm('ç¢ºå®šè¦å¾åˆ—è¡¨ä¸­ç§»é™¤æ­¤é …ç›®å—ï¼Ÿ')) {
                    const updatedTasks = tasks.filter(t => t.id !== id);
                    setTasks(updatedTasks);
                }
            };
            
            // Helper to determine status color
            const getStatusColor = (status) => {
                const s = String(status || '');
                if (s.includes('çµæ¡ˆ') || s.includes('å®Œæˆ')) return 'bg-green-100 text-green-800';
                if (s.includes('é€²è¡Œ') || s.includes('è™•ç†')) return 'bg-yellow-100 text-yellow-800';
                if (s.includes('å–æ¶ˆ')) return 'bg-red-100 text-red-800';
                return 'bg-gray-100 text-gray-800';
            };

            return (
                <div className="p-8 animate-in fade-in">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-gray-800 flex items-center"><span className="mr-2">ğŸ“„</span>ä»»å‹™ç®¡ç† (æœ¬æ‰¹æ¬¡)</h2><span className="text-sm text-gray-500">å…± {tasks.length} ç­†</span></div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div className="overflow-x-auto"><table className="min-w-full divide-y divide-gray-200 text-sm"><thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left font-medium text-gray-500">æ—¥æœŸ</th><th className="px-4 py-3 text-left font-medium text-gray-500">ç‹€æ…‹</th><th className="px-4 py-3 text-left font-medium text-gray-500">ä»»å‹™åˆ†é¡/å…§å®¹</th><th className="px-4 py-3 text-right font-medium text-gray-500">ç¸½é‡‘é¡</th><th className="px-4 py-3 text-right font-medium text-blue-600">ç‡Ÿæ¥­é¡</th><th className="px-4 py-3 text-right font-medium text-gray-500">æ“ä½œ</th></tr></thead><tbody className="divide-y divide-gray-200">{tasks.map(task => (<tr key={task.id} className="hover:bg-gray-50"><td className="px-4 py-3 text-gray-500">{task.date}</td><td className="px-4 py-3"><span className={`px-2 py-1 rounded text-xs ${getStatusColor(task.status)}`}>{task.status || 'æœªæ¨™ç¤º'}</span></td><td className="px-4 py-3"><div className="font-medium text-gray-900">{task.category || task.customerName}</div><div className="text-xs text-gray-500 truncate max-w-xs">{task.content}</div></td><td className="px-4 py-3 text-right">${task.amount?.toLocaleString()}</td><td className="px-4 py-3 text-right font-bold text-blue-600">${task.financials?.turnover?.toLocaleString() || 0}</td><td className="px-4 py-3 text-right"><button onClick={() => handleEdit(task)} className="text-indigo-600 hover:text-indigo-900 mr-3 p-1">âœï¸</button><button onClick={() => handleDelete(task.id)} className="text-red-600 hover:text-red-900 p-1">ğŸ—‘ï¸</button></td></tr>))}{tasks.length === 0 && <tr><td colSpan="7" className="text-center py-10 text-gray-500">å°šæœªåŒ¯å…¥è³‡æ–™ï¼Œè«‹è‡³ã€Œæ´¾å·¥çµç®—æµç¨‹ã€ä¸Šå‚³æª”æ¡ˆã€‚</td></tr>}</tbody></table></div></div>
                    {isEditing && currentTask && (<div className="fixed inset-0 z-[100] bg-gray-500 bg-opacity-75 flex items-center justify-center p-4"><div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 animate-in zoom-in-95"><h3 className="text-lg font-bold mb-4">ç·¨è¼¯ä»»å‹™è³‡æ–™</h3><div className="space-y-4"><div><label className="text-sm">å®¢æˆ¶åç¨±/åˆ†é¡</label><input className="w-full border rounded p-2" value={currentTask.customerName || ''} onChange={e => setCurrentTask({...currentTask, customerName: e.target.value})}/></div><div><label className="text-sm">ç¸½é‡‘é¡</label><input type="number" className="w-full border rounded p-2" value={currentTask.amount || 0} onChange={e => setCurrentTask({...currentTask, amount: Number(e.target.value)})}/></div><div className="bg-yellow-50 p-3 rounded-md text-xs text-yellow-800"><span className="mr-1">âš ï¸</span>ç³»çµ±å°‡ä¾æ“šæ­¤æ–°é‡‘é¡ï¼Œè‡ªå‹•é‡æ–°è¨ˆç®—è©²ç­†ä»»å‹™çš„ç‡Ÿæ¥­é¡èˆ‡åˆ†ç´…(ä¾æ“šå­˜æª”æ™‚çš„æ¯”ä¾‹)ã€‚</div></div><div className="mt-6 flex justify-end space-x-3"><button onClick={() => setIsEditing(false)} className="px-4 py-2 border rounded">å–æ¶ˆ</button><button onClick={handleSave} className="px-4 py-2 bg-blue-600 text-white rounded">å„²å­˜</button></div></div></div>)}
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null); // Add back user state for login
            const [isLoggedIn, setIsLoggedIn] = useState(false); // Add login state
            const [currentView, setCurrentView] = useState('process'); 
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [libReady, setLibReady] = useState(false);
            const [mergedData, setMergedData] = useState([]);
            const [fileName, setFileName] = useState('');
            const [imgProcessing, setImgProcessing] = useState(false);
            
            // å–®ä½ç‹€æ…‹æ”¹ç‚º Local Stateï¼Œåˆå§‹åªæœ‰ doloåœ˜éšŠ
            const [constructionUnits, setConstructionUnits] = useState([
                { id: 'default_hq', name: 'doloåœ˜éšŠ', isInternal: true, defaultRatio: 40, isDefaultHQ: true }
            ]);
            const [salesUnits, setSalesUnits] = useState([
                { id: 'default_hq', name: 'doloåœ˜éšŠ', isInternal: true, defaultRatio: 0, isDefaultHQ: true }
            ]);
            
            const [shareholders, setShareholders] = useState([]);
            const [viewingShareholderDetail, setViewingShareholderDetail] = useState(null); 

            // è¦å‰‡ 3: åˆ·æ–°æ™‚å¼·åˆ¶æ­¸é›¶ (é›–ç„¶ useState é è¨­å°±æ˜¯é€™æ¨£ï¼Œä½†æ˜ç¢ºå¯«å‡ºä¾†)
            useEffect(() => {
                setMergedData([]);
                setStep(1);
                setFileName('');
            }, []);

            useEffect(() => {
                const init = async () => {
                    try { await loadXLSX(); setLibReady(true); } catch (e) { setError('ç„¡æ³•è¼‰å…¥ Excel è§£æå…ƒä»¶ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚'); }
                };
                init();
            }, []);

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoading(true); setError(''); setFileName(file.name);
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = window.XLSX.read(data, { type: 'array', cellDates: true }); 
                        if (workbook.SheetNames.length < 2) throw new Error('Excel æª”æ¡ˆè‡³å°‘éœ€åŒ…å«å…©å€‹å·¥ä½œè¡¨');
                        const taskList = window.XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: '' });
                        const reportList = window.XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[1]], { defval: '' });
                        await processAndMergeData(taskList, reportList);
                    } catch (err) { console.error(err); setError(err.message || 'æª”æ¡ˆè§£æå¤±æ•—'); setLoading(false); }
                };
                reader.readAsArrayBuffer(file);
            };

            const processAndMergeData = async (taskList, reportList) => {
                const merged = [];
                const reportMap = new Map();
                reportList.forEach(row => { const id = getFuzzyValue(row, 'ä»»å‹™ç·¨è™Ÿ'); if (id) reportMap.set(String(id).trim(), row); });

                let currentCUnits = [...constructionUnits];
                let currentSUnits = [...salesUnits];
                
                const resolveUnit = (name, type) => {
                    const cleanName = (name || '').trim();
                    if (!cleanName || cleanName === 'doloåœ˜éšŠ' || cleanName === 'ç¸½éƒ¨') {
                        return { id: 'default_hq', ratio: type === 'c' ? 40 : 0 };
                    }
                    
                    let list = type === 'c' ? currentCUnits : currentSUnits;
                    let existing = list.find(u => u.name === cleanName);
                    
                    if (existing) {
                        return { id: existing.id, ratio: existing.defaultRatio };
                    }
                    
                    const newId = `temp_${type}_${Date.now()}_${Math.random().toString(36).substring(7)}`;
                    const defaultRatio = type === 'c' ? 60 : 10; 
                    const newUnit = { 
                        id: newId, 
                        name: cleanName, 
                        defaultRatio: defaultRatio, 
                        isInternal: false,
                        phone: '', 
                        createdAt: new Date()
                    };
                    
                    if (type === 'c') currentCUnits.push(newUnit);
                    else currentSUnits.push(newUnit);
                    
                    return { id: newId, ratio: defaultRatio };
                };

                taskList.forEach(task => {
                    const taskId = String(getFuzzyValue(task, 'ä»»å‹™ç·¨è™Ÿ')).trim();
                    if (!taskId) return;
                    const report = reportMap.get(taskId) || {};
                    let rawAmount = getFuzzyValue(report, 'å¯¦éš›æ”¶æ¬¾é‡‘é¡', 'å¯¦æ”¶é‡‘é¡') || '0';
                    if (typeof rawAmount === 'string') rawAmount = rawAmount.replace(/,/g, '');
                    const amount = parseFloat(rawAmount) || 0;
                    const isSelected = amount > 500;
                    const finalDate = formatExcelDate(getFuzzyValue(report, 'ä»»å‹™çµæ¡ˆæ—¥æœŸ', 'çµæ¡ˆæ—¥æœŸ')) || formatExcelDate(getFuzzyValue(task, 'ä»»å‹™çµæ¡ˆæ—¥æœŸ')) || '';
                    
                    const creator = getFuzzyValue(report, 'ä»»å‹™å»ºç«‹äºº') || getFuzzyValue(task, 'ä»»å‹™å»ºç«‹äºº');
                    const closer = getFuzzyValue(report, 'ä»»å‹™çµæ¡ˆäºº') || getFuzzyValue(task, 'ä»»å‹™çµæ¡ˆäºº');

                    const cUnitData = resolveUnit(closer, 'c');
                    const sUnitData = resolveUnit(creator, 's');

                    merged.push({
                        id: taskId, customerId: getFuzzyValue(task, 'å®¢æˆ¶ç·¨è™Ÿ'), customerName: getFuzzyValue(task, 'å®¢æˆ¶åç¨±') || getFuzzyValue(task, 'å®¢æˆ¶') || '',
                        location: getFuzzyValue(task, 'ä»»å‹™åœ°é»'), content: getFuzzyValue(task, 'ä»»å‹™å…§å®¹'), 
                        status: getFuzzyValue(task, 'ä»»å‹™ç‹€æ…‹') || '', 
                        processStatus: getFuzzyValue(task, 'è™•ç†ç‹€æ…‹'),
                        date: finalDate, responder: getFuzzyValue(report, 'å›è¦†äºº'), 
                        creator: creator, 
                        closer: closer,
                        category: getFuzzyValue(report, 'ä»»å‹™åˆ†é¡') || getFuzzyValue(task, 'ä»»å‹™åˆ†é¡') || '', amount: amount, 
                        
                        constructionUnitId: cUnitData.id, 
                        salesUnitId: sUnitData.id,
                        constructionRatio: cUnitData.ratio, 
                        salesRatio: sUnitData.ratio,
                        
                        isDuplicate: false, selected: isSelected, financials: { turnover: 0, salesCost: 0, constructionCost: 0 }
                    });
                });
                
                merged.sort((a, b) => {
                    const da = a.date ? new Date(a.date).getTime() : 0;
                    const db = b.date ? new Date(b.date).getTime() : 0;
                    return db - da;
                });

                setConstructionUnits(currentCUnits);
                setSalesUnits(currentSUnits);
                
                setMergedData(merged);
                setLoading(false); setStep(2);
            };

            const updateRowData = (index, field, value) => {
                const newData = [...mergedData]; const row = newData[index]; row[field] = value;
                if (field === 'salesUnitId') {
                    const selectedUnit = salesUnits.find(u => u.id === value);
                    if (selectedUnit) row.salesRatio = (selectedUnit.name === 'doloåœ˜éšŠ') ? 0 : (parseFloat(selectedUnit.defaultRatio) || 0);
                }
                if (field === 'constructionUnitId') {
                    const selectedUnit = constructionUnits.find(u => u.id === value);
                    if (selectedUnit) row.constructionRatio = (selectedUnit.name === 'doloåœ˜éšŠ') ? 40 : (parseFloat(selectedUnit.defaultRatio) || 0);
                }
                setMergedData(newData);
            };

            const calculateFinancials = (row) => {
                const amount = row.amount;
                const cUnit = constructionUnits.find(u => u.id === row.constructionUnitId) || constructionUnits[0] || {};
                const sUnit = salesUnits.find(u => u.id === row.salesUnitId) || salesUnits[0] || {};
                let salesCost = (sUnit.name === 'doloåœ˜éšŠ') ? 0 : Math.round(amount * (row.salesRatio / 100));
                let constructionCost = (cUnit.name === 'doloåœ˜éšŠ') ? Math.round(amount * 0.40) : Math.round(amount * (row.constructionRatio / 100));
                const turnover = amount - salesCost - constructionCost;
                return { salesCost, constructionCost, turnover, isDoloConstruction: cUnit.name === 'doloåœ˜éšŠ', deptBonus: Math.round(turnover * BONUS_RATIOS.dept), companyFunds: Math.round(turnover * BONUS_RATIOS.company) };
            };

            const saveToDatabase = async () => {
                setLoading(true);
                setTimeout(() => {
                    setLoading(false);
                    setStep(6); 
                }, 500);
            };

            const generateReportImage = async (title, metaInfo, tableHeaders, tableData, totalInfo, signatures) => {
                const container = document.createElement('div');
                container.style.position = 'absolute';
                container.style.top = '-9999px';
                container.style.left = '0';
                container.style.width = '794px'; // A4 width at 96 DPI
                container.style.backgroundColor = 'white';
                container.style.padding = '40px';
                container.style.fontFamily = '"Microsoft JhengHei", "Noto Sans TC", sans-serif';
                container.style.color = 'black';
                
                // Helper for table rows
                const rowsHtml = tableData.map(row => `
                    <tr>
                        ${row.map((cell, i) => `<td style="border: 1px solid #000; padding: 6px; text-align: ${i >= row.length - 2 || (tableHeaders.includes('ç¸½é‡‘é¡') && i===3) ? 'right' : (i<=1 || (i===4 && tableHeaders.includes('åˆ†ç´…æ¯”ä¾‹')) ? 'center' : 'left')}; font-family: ${i >= row.length - 1 ? '"Courier New", monospace' : 'inherit'}; font-weight: ${i === row.length - 1 ? 'bold' : 'normal'};">${cell}</td>`).join('')}
                    </tr>
                `).join('');

                container.innerHTML = `
                    <h1 style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 5px;">${title}</h1>
                    <div style="text-align: center; font-size: 14px; color: #555; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #000;">åˆ—å°æ—¥æœŸ: ${new Date().toLocaleDateString()}</div>
                    
                    ${metaInfo.map(info => `<div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 16px;"><span style="font-weight: bold;">${info.label}</span><span>${info.value}</span></div>`).join('')}
                    
                    ${totalInfo ? `<div style="border: 2px solid #000; padding: 10px 15px; margin: 15px 0; display: flex; justify-content: space-between; align-items: center; background-color: white;"><span style="font-weight: bold; font-size: 18px;">${totalInfo.label}</span><span style="font-weight: 900; font-size: 20px; font-family: 'Courier New', monospace;">${totalInfo.value}</span></div>` : ''}
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 13px;">
                        <thead>
                            <tr>${tableHeaders.map(h => `<th style="border: 1px solid #000; padding: 6px; background-color: #eee; font-weight: bold; text-align: center;">${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 50px;">
                        ${signatures.map(s => `<div style="width: 200px; border-top: 1px solid #000; padding-top: 10px; text-align: center; font-size: 16px;">${s}</div>`).join('')}
                    </div>
                `;

                document.body.appendChild(container);
                try {
                    const canvas = await html2canvas(container, { scale: 2 }); // 2x scale for better quality
                    document.body.removeChild(container);
                    return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                } catch (e) {
                    console.error("Image generation failed", e);
                    if(document.body.contains(container)) document.body.removeChild(container);
                    return null;
                }
            };

            const handleDownloadAllImages = async () => {
                if (!window.JSZip || !window.saveAs || !window.html2canvas) {
                    alert("å¿…è¦å…ƒä»¶è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦");
                    return;
                }
                
                if (!confirm("å³å°‡ç”¢ç”Ÿæ‰€æœ‰å ±è¡¨åœ–æª”ï¼Œé€™å¯èƒ½éœ€è¦å¹¾ç§’é˜çš„æ™‚é–“ã€‚ç¢ºå®šç¹¼çºŒå—ï¼Ÿ")) return;

                setImgProcessing(true);
                const zip = new JSZip();
                const folder = zip.folder("å ±è¡¨åœ–æª”");
                const activeData = mergedData.filter(r => r.selected);

                // 1. éƒ¨é–€å ±è¡¨
                for (const dept of DEPARTMENTS_CONFIG) {
                    const ratioDecimal = BONUS_RATIOS[dept.key] || (dept.ratio / 100);
                    const deptJobs = activeData; // å…¨åŸŸè¨ˆç®—
                    const totalBonus = deptJobs.reduce((acc, job) => {
                        const turnover = calculateFinancials(job).turnover;
                        return acc + Math.round(turnover * ratioDecimal);
                    }, 0);

                    const tableData = deptJobs.map(job => {
                        const financials = calculateFinancials(job);
                        const bonus = Math.round(financials.turnover * ratioDecimal);
                        return [job.date, job.id, job.category || job.customerName, `$${financials.turnover.toLocaleString()}`, `$${bonus.toLocaleString()}`];
                    });

                    const blob = await generateReportImage(
                        "dolo ERPç³»çµ± - éƒ¨é–€åˆ†ç´…å ±è¡¨",
                        [{ label: "éƒ¨é–€åç¨±ï¼š", value: dept.name }, { label: "åˆ†ç´…æ¯”ä¾‹ï¼š", value: `${dept.ratio}%` }],
                        ["æ—¥æœŸ", "ä»»å‹™ç·¨è™Ÿ", "ä»»å‹™åˆ†é¡", "è©²æ¡ˆç‡Ÿæ¥­é¡", "åˆ†ç´…é‡‘é¡"],
                        tableData,
                        { label: "æœ¬æœŸæ‡‰é ˜åˆ†ç´…ç¸½é¡", value: `$${totalBonus.toLocaleString()}` },
                        ["æœƒè¨ˆç°½ç« ", "éƒ¨é–€ä¸»ç®¡ç°½ç« "]
                    );
                    if (blob) folder.file(`éƒ¨é–€_${dept.name}.jpg`, blob);
                }

                // 2. è‚¡æ±å ±è¡¨
                const globalPool = activeData.reduce((acc, job) => acc + (calculateFinancials(job).turnover * BONUS_RATIOS.dividends), 0);
                for (const s of shareholders) {
                    const ratio = parseFloat(s.ratio) || 0;
                    const myTotal = Math.round(globalPool * (ratio / 100));
                    
                    const tableData = activeData.map(job => {
                        const financials = calculateFinancials(job);
                        const pool = Math.round(financials.turnover * BONUS_RATIOS.dividends);
                        const share = Math.round(pool * (ratio / 100));
                        return [job.date, job.id, job.category || job.customerName, `$${financials.turnover.toLocaleString()}`, `$${share.toLocaleString()}`];
                    });

                    const blob = await generateReportImage(
                        "dolo ERPç³»çµ± - è‚¡æ±åˆ†ç´…å ±è¡¨",
                        [{ label: "è‚¡æ±å§“åï¼š", value: s.name }, { label: "æŒè‚¡æ¯”ä¾‹ï¼š", value: `${ratio}%` }],
                        ["æ—¥æœŸ", "ä»»å‹™ç·¨è™Ÿ", "ä»»å‹™åˆ†é¡", "è©²æ¡ˆç‡Ÿæ¥­é¡", "å€‹äººåˆ†ç´…"],
                        tableData,
                        { label: "æœ¬æœŸæ‡‰é ˜åˆ†ç´…ç¸½é¡", value: `$${myTotal.toLocaleString()}` },
                        ["ç¶“æ‰‹äººç°½ç« ", "é ˜æ¬¾äººç°½ç« "]
                    );
                    if (blob) folder.file(`è‚¡æ±_${s.name}.jpg`, blob);
                }

                // 3. æ¥­å‹™å–®ä½å ±è¡¨ (åªç”¢å‡ºæœ‰é‡‘é¡çš„)
                for (const u of salesUnits) {
                    const relatedJobs = activeData.filter(j => j.salesUnitId === u.id);
                    if (relatedJobs.length === 0) continue;
                    
                    const totalIncome = relatedJobs.reduce((acc, job) => acc + calculateFinancials(job).salesCost, 0);
                    const tableData = relatedJobs.map(job => {
                        const financials = calculateFinancials(job);
                        // Modified: sales report headers
                        return [
                            job.date, 
                            job.id, 
                            job.category || job.customerName, 
                            `$${job.amount.toLocaleString()}`, // Total Amount
                            `${job.salesRatio}%`, 
                            `$${financials.salesCost.toLocaleString()}`
                        ];
                    });

                    const blob = await generateReportImage(
                        "dolo ERPç³»çµ± - æ¥­å‹™åˆ†æ½¤å ±è¡¨",
                        [{ label: "å–®ä½åç¨±ï¼š", value: u.name }],
                        ["æ—¥æœŸ", "ä»»å‹™ç·¨è™Ÿ", "ä»»å‹™åˆ†é¡", "ç¸½é‡‘é¡", "åˆ†ç´…æ¯”ä¾‹", "æ¥­å‹™åˆ†æ½¤"], // Updated header
                        tableData,
                        { label: "æœ¬æœŸæ‡‰é ˜åˆ†æ½¤ç¸½é¡", value: `$${totalIncome.toLocaleString()}` },
                        ["ç¶“æ‰‹äººç°½ç« ", "é ˜æ¬¾äººç°½ç« "]
                    );
                    if (blob) folder.file(`æ¥­å‹™_${u.name}.jpg`, blob);
                }

                // 4. æ–½å·¥å–®ä½å ±è¡¨ (åªç”¢å‡ºæœ‰é‡‘é¡çš„)
                for (const u of constructionUnits) {
                    const relatedJobs = activeData.filter(j => j.constructionUnitId === u.id);
                    if (relatedJobs.length === 0) continue;
                    
                    const totalIncome = relatedJobs.reduce((acc, job) => acc + calculateFinancials(job).constructionCost, 0);
                    const tableData = relatedJobs.map(job => {
                        const financials = calculateFinancials(job);
                        // Modified: construction report headers
                        return [
                            job.date, 
                            job.id, 
                            job.category || job.customerName, 
                            `$${job.amount.toLocaleString()}`, // Total Amount
                            `${job.constructionRatio}%`, 
                            `$${financials.constructionCost.toLocaleString()}`
                        ];
                    });

                    const blob = await generateReportImage(
                        "dolo ERPç³»çµ± - æ–½å·¥è²»ç”¨å ±è¡¨",
                        [{ label: "å–®ä½åç¨±ï¼š", value: u.name }],
                        ["æ—¥æœŸ", "ä»»å‹™ç·¨è™Ÿ", "ä»»å‹™åˆ†é¡", "ç¸½é‡‘é¡", "åˆ†ç´…æ¯”ä¾‹", "æ–½å·¥è²»ç”¨"], // Updated header
                        tableData,
                        { label: "æœ¬æœŸæ‡‰é ˜è²»ç”¨ç¸½é¡", value: `$${totalIncome.toLocaleString()}` },
                        ["ç¶“æ‰‹äººç°½ç« ", "é ˜æ¬¾äººç°½ç« "]
                    );
                    if (blob) folder.file(`æ–½å·¥_${u.name}.jpg`, blob);
                }

                zip.generateAsync({type:"blob"}).then(function(content) {
                    saveAs(content, `dolo_all_reports_images_${new Date().toISOString().slice(0,10)}.zip`);
                    setImgProcessing(false);
                });
            };

            const handleBackupZip = () => {
                if (!window.JSZip || !window.saveAs) {
                    alert("å‚™ä»½åŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦");
                    return;
                }

                const zip = new JSZip();
                
                // 1. Snapshot JSON (Core restore data)
                const snapshot = {
                    version: "1.0.0",
                    exportedAt: new Date().toISOString(),
                    sourceFileName: fileName || "unknown",
                    state: {
                        mergedData,
                        salesUnits,
                        constructionUnits,
                        shareholders,
                        step
                    }
                };
                zip.file("snapshot.json", JSON.stringify(snapshot, null, 2));

                // 2. Data Folder (Reports in JSON for future use)
                const reportFolder = zip.folder("reports");
                
                // Shareholders Report
                const shareholdersReport = shareholders.map(s => {
                    const pool = Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+(r.financials?.turnover || 0)*BONUS_RATIOS.dividends,0)*0.15);
                    const ratio = parseFloat(s.ratio) || 0;
                    return {
                        name: s.name,
                        role: s.role,
                        shares: s.shares,
                        ratio: `${ratio}%`,
                        bonus: Math.round(pool * (ratio / 100))
                    };
                });
                reportFolder.file("è‚¡æ±åˆ†ç´…ç¸½è¡¨.json", JSON.stringify(shareholdersReport, null, 2));

                // Departments Report
                const deptReport = DEPARTMENTS_CONFIG.map(d => {
                    const ratioDecimal = BONUS_RATIOS[d.key] || (d.ratio / 100);
                    const totalBonus = mergedData.filter(r => r.selected).reduce((acc, job) => acc + Math.round((job.financials?.turnover || 0) * ratioDecimal), 0);
                    return {
                        name: d.name,
                        ratio: `${d.ratio}%`,
                        totalBonus: totalBonus
                    };
                });
                reportFolder.file("éƒ¨é–€åˆ†ç´…ç¸½è¡¨.json", JSON.stringify(deptReport, null, 2));

                // Tasks Data
                const tasksData = mergedData.filter(r => r.selected).map(t => ({
                    date: t.date,
                    id: t.id,
                    category: t.category,
                    customer: t.customerName,
                    amount: t.amount,
                    turnover: t.financials?.turnover,
                    salesUnit: salesUnits.find(u => u.id === t.salesUnitId)?.name,
                    constructionUnit: constructionUnits.find(u => u.id === t.constructionUnitId)?.name
                }));
                reportFolder.file("ä»»å‹™æ¸…å–®.json", JSON.stringify(tasksData, null, 2));

                // Generate Zip
                zip.generateAsync({type:"blob"}).then(function(content) {
                    saveAs(content, `dolo_backup_${new Date().toISOString().slice(0,10)}.zip`);
                });
            };

            const handleRestoreSnapshot = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    let snapshot;

                    // æª¢æŸ¥æ˜¯å¦ç‚º ZIP æª”
                    if (file.name.endsWith('.zip')) {
                        const zip = await JSZip.loadAsync(file);
                        const snapshotFile = zip.file("snapshot.json");
                        if (snapshotFile) {
                            const text = await snapshotFile.async("string");
                            snapshot = JSON.parse(text);
                        } else {
                            alert("ZIP æª”ä¸­æ‰¾ä¸åˆ° snapshot.json");
                            return;
                        }
                    } else {
                        // å‡è¨­æ˜¯ JSON æª”
                        const text = await file.text();
                        snapshot = JSON.parse(text);
                    }

                    if (!snapshot.state) { 
                        alert("ä¸æ˜¯æœ‰æ•ˆçš„å‚™ä»½æª”");
                        return;
                    }

                    const { mergedData, salesUnits, constructionUnits, shareholders, step } = snapshot.state;

                    setMergedData(mergedData || []);
                    setSalesUnits(salesUnits || []);
                    setConstructionUnits(constructionUnits || []);
                    setShareholders(shareholders || []);
                    setStep(step || 1);
                    setFileName(snapshot.sourceFileName || "");

                    alert("å‚™ä»½é‚„åŸå®Œæˆï¼");
                } catch (err) {
                    console.error(err);
                    alert("é‚„åŸå¤±æ•—ï¼Œæª”æ¡ˆå¯èƒ½ææ¯€æˆ–æ ¼å¼éŒ¯èª¤");
                }
                // Clear input to allow re-upload
                e.target.value = '';
            };

            const dataWithFinancials = mergedData.map(row => ({
                ...row,
                financials: calculateFinancials(row)
            }));

            if (!isLoggedIn) {
                return <Login onLogin={() => setIsLoggedIn(true)} />;
            }

            return (
                <div className="flex h-screen bg-gray-50 font-sans text-gray-900 overflow-hidden">
                    <Sidebar currentView={currentView} setCurrentView={setCurrentView} isCollapsed={isSidebarCollapsed} setIsCollapsed={setIsSidebarCollapsed} />
                    <div className={`flex-1 flex flex-col h-screen overflow-hidden ${isSidebarCollapsed ? 'ml-20' : 'ml-64'}`}>
                        <main className="flex-1 overflow-y-auto bg-gray-50 print:bg-white">
                            {currentView === 'settings_sales' && <GenericManager title="æ¥­å‹™å–®ä½ç®¡ç†" icon="ğŸ’¼" collectionName="sales_units" fields={[{ key: 'name', label: 'å§“å', required: true }, { key: 'phone', label: 'é›»è©±' }, { key: 'defaultRatio', label: 'é è¨­åˆ†ç´… (%)', type: 'number', defaultValue: 10 }]} localData={salesUnits} setLocalData={setSalesUnits} currentReportData={dataWithFinancials} />}
                            {currentView === 'settings_construction' && <GenericManager title="æ–½å·¥å–®ä½ç®¡ç†" icon="ğŸ‘·" collectionName="construction_units" fields={[{ key: 'name', label: 'å§“å', required: true }, { key: 'phone', label: 'é›»è©±' }, { key: 'defaultRatio', label: 'é è¨­åˆ†ç´… (%)', type: 'number', defaultValue: 60 }, { key: 'isInternal', label: 'å…¬å¸å…§éƒ¨å–®ä½', type: 'boolean', defaultValue: false }]} localData={constructionUnits} setLocalData={setConstructionUnits} currentReportData={dataWithFinancials} />}
                            {currentView === 'shareholder_management' && <GenericManager title="è‚¡æ±ç®¡ç†" icon="ğŸ‘¥" collectionName="shareholders" fields={[{ key: 'name', label: 'è‚¡æ±å§“å', required: true }, { key: 'role', label: 'è·ç¨±/è§’è‰²' }, { key: 'shares', label: 'æŠ•è³‡è‚¡æ•¸', type: 'number', required: true }, { key: 'ratio', label: 'åˆ†ç´…ç™¾åˆ†æ¯” (%)', type: 'number', required: true }, { key: 'note', label: 'å‚™è¨»' }]} enableBatchImport={true} currentReportData={dataWithFinancials} localData={shareholders} setLocalData={setShareholders} />}
                            {currentView === 'department_management' && <DepartmentManager currentData={dataWithFinancials} />}
                            {currentView === 'task_management' && <TaskManager constructionUnits={constructionUnits} salesUnits={salesUnits} tasks={dataWithFinancials} setTasks={setMergedData} />}
                            
                            {/* Process Steps (Upload -> ... -> Complete) */}
                            {currentView === 'process' && (
                                <div className="max-w-7xl mx-auto px-8 py-8 print:hidden">
                                    <div className="mb-8"><h1 className="text-3xl font-extrabold text-gray-900">æ´¾å·¥çµç®—æµç¨‹</h1><p className="mt-2 text-gray-500">è³‡æ–™åƒ…æš«å­˜æ–¼ç•¶å‰é é¢ï¼Œåˆ·æ–°å³æ¶ˆå¤±ã€‚è«‹è¨˜å¾—åˆ—å°æˆ–æˆªåœ–ã€‚</p></div>
                                    <div className="mb-8"><div className="flex justify-between max-w-4xl mx-auto relative"><div className="absolute top-1/2 w-full h-1 bg-gray-200 -z-10 rounded"></div>{[{id: 1, name: 'ä¸Šå‚³'}, {id: 2, name: 'æ ¸å°'}, {id: 3, name: 'æ‹†å¸³'}, {id: 4, name: 'åˆ†é…'}, {id: 5, name: 'åˆ†ç´…'}].map(s => (<div key={s.id} className={`flex flex-col items-center bg-gray-50 px-3 ${step >= s.id ? 'text-blue-600' : 'text-gray-400'}`}><div className={`w-8 h-8 rounded-full flex items-center justify-center border-4 transition-all ${step >= s.id ? 'bg-white border-blue-600' : 'bg-white border-gray-300'}`}><span className="text-xs font-bold">{s.id}</span></div><span className="text-xs font-bold mt-1">{s.name}</span></div>))}</div></div>
                                    <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 min-h-[500px]">
                                        {step === 1 && (<div className="space-y-6 animate-in fade-in slide-in-from-bottom-4"><div className="bg-white border-2 border-dashed border-blue-300 rounded-xl p-10 text-center hover:border-blue-500 transition-all shadow-sm group"><div className="bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform duration-300"><span className="text-4xl">ğŸ“Š</span></div><h3 className="text-xl font-bold text-gray-800 mb-2">ä¸Šå‚³ Excel æ´¾å·¥æª”æ¡ˆ</h3><div className="flex justify-center gap-4 mt-4"><div className="relative inline-block"><input type="file" accept=".xlsx, .xls" onChange={handleFileUpload} disabled={!libReady || loading} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/><button className="px-8 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 flex items-center font-medium">{loading ? 'è™•ç†ä¸­...' : 'é¸æ“‡æª”æ¡ˆ'} {loading && <span className="ml-2 animate-spin">ğŸ”„</span>}</button></div>
                                        <div className="relative inline-block">
                                            <input type="file" accept=".json, .zip" onChange={handleRestoreSnapshot} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                            <button className="px-6 py-3 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 flex items-center font-medium">
                                                <span className="mr-2">â†©ï¸</span> åŒ¯å…¥å‚™ä»½ (ZIP/JSON)
                                            </button>
                                        </div>
                                        
                                        <div className="relative inline-block">
                                            <input type="file" webkitdirectory="" directory="" onChange={handleRestoreSnapshot} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                            <button className="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 flex items-center font-medium">
                                                <span className="mr-2">ğŸ“‚</span> é¸å–è³‡æ–™å¤¾
                                            </button>
                                        </div></div><p className="text-sm text-gray-500 mt-4">ç³»çµ±å°‡è‡ªå‹•è®€å– Excel å…§å®¹é€²è¡Œè¨ˆç®—</p></div>{error && <div className="p-4 bg-red-50 text-red-700 rounded-lg flex items-center border border-red-100"><span className="mr-3">âš ï¸</span>{error}</div>}</div>)}
                                        {step === 2 && (<div className="space-y-4 animate-in fade-in slide-in-from-bottom-4"><div className="flex justify-between items-center mb-4"><div className="bg-yellow-50 text-yellow-800 px-4 py-2 rounded-lg text-sm border border-yellow-200 flex items-center"><span className="mr-2">âš ï¸</span>é è¨­å‹¾é¸ï¼šé‡‘é¡ &gt; $500 çš„é …ç›®</div><div className="text-sm text-gray-500">å…± {mergedData.length} ç­†</div></div><div className="overflow-x-auto border rounded-lg"><table className="min-w-full divide-y divide-gray-200 text-sm"><thead className="bg-gray-50"><tr><th className="px-3 py-3 w-10">é¸</th><th className="px-3 py-3 text-left font-medium text-gray-500">æ—¥æœŸ</th><th className="px-3 py-3">ä»»å‹™ç·¨è™Ÿ</th><th className="px-3 py-3">å…§å®¹</th><th className="px-3 py-3 bg-orange-50 text-orange-800">å»ºç«‹äºº</th><th className="px-3 py-3 bg-green-50 text-green-800">çµæ¡ˆäºº</th><th className="px-3 py-3 text-right">é‡‘é¡</th><th className="px-3 py-3 w-10">åˆª</th></tr></thead><tbody className="divide-y divide-gray-200">{mergedData.map((row, i) => (<tr key={i} className={row.selected ? 'bg-blue-50/30' : ''}><td className="px-3 py-3 text-center"><input type="checkbox" checked={row.selected} onChange={e=>updateRowData(i,'selected',e.target.checked)} className="h-4 w-4 rounded border-gray-300 text-blue-600"/></td><td className="px-3 py-3 text-gray-500 font-mono text-xs">{row.date}</td><td className="px-3 py-3"><div className="font-medium text-gray-900">{row.id}</div>{row.isDuplicate && <span className="text-xs text-red-600 bg-red-100 px-1 rounded">é‡è¤‡</span>}</td><td className="px-3 py-3 text-gray-500 truncate max-w-[200px]">{row.content}</td><td className="px-3 py-3 bg-orange-50/20">{row.creator}</td><td className="px-3 py-3 bg-green-50/20">{row.closer}</td><td className="px-3 py-3 text-right font-medium">${row.amount.toLocaleString()}</td><td className="px-3 py-3 text-center"><button onClick={()=>{const n=[...mergedData];n.splice(i,1);setMergedData(n)}} className="text-red-400 hover:text-red-600">ğŸ—‘ï¸</button></td></tr>))}</tbody></table></div><div className="flex justify-between pt-4"><button onClick={()=>{setStep(1);setMergedData([])}} className="text-gray-500 hover:text-gray-900">é‡æ–°ä¸Šå‚³</button><button onClick={()=>setStep(3)} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md">ä¸‹ä¸€æ­¥</button></div></div>)}
                                        {step === 3 && (<div className="space-y-4 animate-in fade-in slide-in-from-bottom-4"><div className="overflow-x-auto overflow-y-visible border rounded-lg"><table className="min-w-full divide-y divide-gray-200 text-sm"><thead className="bg-gray-50"><tr><th className="px-3 py-3 text-left w-24">çµæ¡ˆæ—¥æœŸ</th><th className="px-3 py-3 text-left w-28">åˆ†é¡</th><th className="px-3 py-3 text-left w-32">å®¢æˆ¶</th><th className="px-3 py-3 text-right">ç¸½é‡‘é¡</th><th className="px-3 py-3 text-left w-48">æ¥­å‹™å–®ä½ (ä¸»å°)</th><th className="px-3 py-3 text-left w-48">æ–½å·¥å–®ä½</th><th className="px-3 py-3 text-right bg-blue-50 text-blue-800">ç‡Ÿæ¥­é¡</th></tr></thead><tbody className="divide-y divide-gray-200">{mergedData.filter(r=>r.selected && !r.isDuplicate).map((row) => { const realIndex = mergedData.findIndex(r => r.id === row.id); const financials = calculateFinancials(row); return (<tr key={row.id}><td className="px-3 py-3 text-gray-500">{row.date}</td><td className="px-3 py-3"><span className="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">{row.category}</span></td><td className="px-3 py-3 font-medium text-gray-700">{row.customerName}</td><td className="px-3 py-3 text-right font-bold text-gray-900">${row.amount.toLocaleString()}</td><td className="px-3 py-3"><select value={row.salesUnitId} onChange={e=>updateRowData(realIndex,'salesUnitId',e.target.value)} className="block w-full border-gray-300 rounded-md text-xs shadow-sm focus:ring-purple-500 focus:border-purple-500 cursor-pointer">{salesUnits.map(u=><option key={u.id} value={u.id}>{u.name}</option>)}</select><div className="text-xs text-purple-600 mt-1 pl-1">åˆ†æ½¤ ({row.salesRatio}%): ${financials.salesCost.toLocaleString()}</div></td><td className="px-3 py-3"><select value={row.constructionUnitId} onChange={e=>updateRowData(realIndex,'constructionUnitId',e.target.value)} className="block w-full border-gray-300 rounded-md text-xs shadow-sm focus:ring-orange-500 focus:border-orange-500 cursor-pointer">{constructionUnits.map(u=><option key={u.id} value={u.id}>{u.name}</option>)}</select><div className="text-xs text-orange-600 mt-1 pl-1">{financials.isDoloConstruction ? (<span>æ‰£é™¤: ${financials.constructionCost.toLocaleString()} <span className="text-gray-400">(40%)</span></span>) : (<span>æ‰£é™¤: ${financials.constructionCost.toLocaleString()} <span className="text-gray-400">({row.constructionRatio}%)</span></span>)}</div></td><td className="px-3 py-3 text-right bg-blue-50 font-bold text-blue-700">${financials.turnover.toLocaleString()}</td></tr>); })}</tbody><tfoot className="bg-gray-800 text-white"><tr><td colSpan={6} className="px-6 py-4 text-right">æœ¬æ‰¹æ¬¡ç¸½ç‡Ÿæ¥­é¡</td><td className="px-6 py-4 text-right text-xl font-bold text-green-400">${mergedData.filter(r=>r.selected && !r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0).toLocaleString()}</td></tr></tfoot></table></div><div className="flex justify-between pt-4"><button onClick={()=>setStep(2)} className="text-gray-500 hover:text-gray-900">ä¸Šä¸€æ­¥</button><button onClick={()=>setStep(4)} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md">ä¸‹ä¸€æ­¥ï¼šæŸ¥çœ‹ç‡Ÿæ”¶åˆ†é…</button></div></div>)}
                                        {step === 4 && (<div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 p-6 rounded-xl flex flex-col items-center">
                                                    <h3 className="text-lg font-medium text-blue-800 mb-2">æœ¬æ‰¹æ¬¡ç¸½é‡‘é¡</h3>
                                                    <div className="text-4xl font-extrabold text-blue-600 tracking-tight">${mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+r.amount,0).toLocaleString()}</div>
                                                </div>
                                                <div className="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 p-6 rounded-xl flex flex-col items-center">
                                                    <h3 className="text-lg font-medium text-green-800 mb-2">æœ¬æ‰¹æ¬¡ç¸½ç‡Ÿæ¥­é¡</h3>
                                                    <div className="text-4xl font-extrabold text-green-600 tracking-tight">${mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0).toLocaleString()}</div>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="bg-white border rounded-xl shadow-sm p-6"><div className="flex items-center justify-between mb-4 border-b pb-2"><h4 className="font-bold text-gray-800 flex items-center"><span className="mr-2">ğŸ‘¥</span>éƒ¨é–€åˆ†ç´… (55%)</h4><span className="text-lg font-bold text-blue-600">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.55).toLocaleString()}</span></div><div className="space-y-3 text-sm"><div className="flex justify-between"><span>ç¸½ç‡Ÿé‹é•· (30%)</span><span className="font-medium">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.30).toLocaleString()}</span></div><div className="flex justify-between"><span>æœƒè¨ˆè¡Œæ”¿&æ¥­å‹™æ´¾å·¥ (10%)</span><span className="font-medium">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.10).toLocaleString()}</span></div><div className="flex justify-between"><span>ç³»çµ±ç¶­è­·&è¡ŒéŠ·ç®¡ç† (5%)</span><span className="font-medium">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.05).toLocaleString()}</span></div><div className="flex justify-between"><span>ç¾ç·¨è¨­è¨ˆ&ç¤¾ç¾¤ç®¡ç† (5%)</span><span className="font-medium">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.05).toLocaleString()}</span></div><div className="flex justify-between"><span>æŠ€è¡“ä¸»ç®¡ (5%)</span><span className="font-medium">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.05).toLocaleString()}</span></div></div></div><div className="bg-white border rounded-xl shadow-sm p-6"><div className="flex items-center justify-between mb-4 border-b pb-2"><h4 className="font-bold text-gray-800 flex items-center"><span className="mr-2">ğŸ¥§</span>å…¬å¸ç¸½é«”è³‡é‡‘é…ç½® (45%)</h4><span className="text-lg font-bold text-purple-600">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.45).toLocaleString()}</span></div><div className="space-y-3 text-sm"><div className="flex justify-between"><span>å…¬å¸ç‡Ÿé‹æˆæœ¬ (25%)</span><span className="font-medium">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.25).toLocaleString()}</span></div><div className="flex justify-between"><span>è³‡é‡‘èˆ‡æŠ•è³‡äººæ¯”ä¾‹åˆ†ç´… (15%)</span><span className="font-medium">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.15).toLocaleString()}</span></div><div className="flex justify-between"><span>å¹´åº¦ä¿ç•™é‡‘ (5%)</span><span className="font-medium">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.05).toLocaleString()}</span></div></div></div></div><div className="bg-white border rounded-xl shadow-sm overflow-visible"><div className="px-6 py-4 border-b bg-gray-50 flex items-center"><span className="mr-2">ğŸ“</span><h4 className="font-bold text-gray-800">æœ¬æœŸç‡Ÿæ”¶æ˜ç´°è¡¨</h4></div><div className="overflow-x-auto overflow-y-visible"><table className="min-w-full divide-y divide-gray-200 text-sm"><thead className="bg-gray-50 relative z-10"><tr><th className="px-6 py-3 text-left font-medium text-gray-500">æ—¥æœŸ</th><th className="px-6 py-3 text-left font-medium text-gray-500">é …ç›®</th><th className="px-6 py-3 text-left font-medium text-gray-500">å®¢æˆ¶</th><th className="px-6 py-3 text-right font-medium text-gray-500">ç¸½é‡‘é¡</th><th className="px-6 py-3 text-right font-bold text-blue-600">ç‡Ÿæ¥­é¡</th><th className="px-6 py-3 text-right font-medium text-green-600 bg-green-50">éƒ¨é–€åˆ†ç´…(55%)</th><th className="px-6 py-3 text-right font-medium text-purple-600 bg-purple-50">è³‡é‡‘é…ç½®(45%)</th></tr></thead><tbody className="divide-y divide-gray-200 relative z-0">{mergedData.filter(r=>r.selected && !r.isDuplicate).map((row, i) => { const financials = calculateFinancials(row); const tooltipPosClass = i < 5 ? "top-full mt-1" : "bottom-full mb-1"; const deptBreakdown = [{ label: 'ç¸½ç‡Ÿé‹é•· (30%)', val: Math.round(financials.turnover * BONUS_RATIOS.coo) }, { label: 'æœƒè¨ˆè¡Œæ”¿&æ¥­å‹™æ´¾å·¥ (10%)', val: Math.round(financials.turnover * BONUS_RATIOS.admin) }, { label: 'ç³»çµ±ç¶­è­·&è¡ŒéŠ·ç®¡ç† (5%)', val: Math.round(financials.turnover * BONUS_RATIOS.marketing) }, { label: 'ç¾ç·¨è¨­è¨ˆ&ç¤¾ç¾¤ç®¡ç† (5%)', val: Math.round(financials.turnover * BONUS_RATIOS.design) }, { label: 'æŠ€è¡“ä¸»ç®¡ (5%)', val: Math.round(financials.turnover * BONUS_RATIOS.tech) }]; const companyBreakdown = [{ label: 'å…¬å¸ç‡Ÿé‹æˆæœ¬ (25%)', val: Math.round(financials.turnover * BONUS_RATIOS.opCost) }, { label: 'è³‡é‡‘èˆ‡æŠ•è³‡äººæ¯”ä¾‹åˆ†ç´… (15%)', val: Math.round(financials.turnover * BONUS_RATIOS.dividends) }, { label: 'å¹´åº¦ä¿ç•™é‡‘ (5%)', val: Math.round(financials.turnover * BONUS_RATIOS.reserve) }]; return (<tr key={row.id} className="hover:bg-gray-50 relative"><td className="px-6 py-3 text-gray-500">{row.date}</td><td className="px-6 py-3 text-gray-900">{row.id}</td><td className="px-6 py-3 text-gray-600">{row.customerName}</td><td className="px-6 py-3 text-right text-gray-900">${row.amount.toLocaleString()}</td><td className="px-6 py-3 text-right font-bold text-blue-600">${financials.turnover.toLocaleString()}</td><td className="px-6 py-3 text-right text-green-600 bg-green-50 relative"><div className="group/dept inline-block relative"><div className="font-bold cursor-help border-b border-dotted border-green-400 inline-block relative z-20">${financials.deptBonus.toLocaleString()}</div><div className={`absolute ${tooltipPosClass} left-1/2 -translate-x-1/2 hidden group-hover/dept:block bg-gray-900 text-white text-xs rounded p-3 shadow-xl w-60 text-left z-[999] pointer-events-none`}><div className="font-bold mb-2">éƒ¨é–€åˆ†ç´…æ˜ç´°</div><div className="space-y-1">{deptBreakdown.map((d, idx) => (<div key={idx} className="flex justify-between gap-3"><span className="opacity-90">{d.label}</span><span className="font-mono font-bold">${d.val.toLocaleString()}</span></div>))}</div><div className="border-t border-white/20 mt-2 pt-2 flex justify-between"><span className="font-bold">åˆè¨ˆ</span><span className="font-mono font-bold">${financials.deptBonus.toLocaleString()}</span></div></div></div></td><td className="px-6 py-3 text-right text-purple-600 bg-purple-50 relative"><div className="group/company inline-block relative"><div className="font-bold cursor-help border-b border-dotted border-purple-400 inline-block relative z-20">${financials.companyFunds.toLocaleString()}</div><div className={`absolute ${tooltipPosClass} right-0 hidden group-hover/company:block bg-gray-900 text-white text-xs rounded p-3 shadow-xl w-60 text-left z-[999] pointer-events-none`}><div className="font-bold mb-2">è³‡é‡‘é…ç½®æ˜ç´°</div><div className="space-y-1">{companyBreakdown.map((d, idx) => (<div key={idx} className="flex justify-between gap-3"><span className="opacity-90">{d.label}</span><span className="font-mono font-bold">${d.val.toLocaleString()}</span></div>))}</div><div className="border-t border-white/20 mt-2 pt-2 flex justify-between"><span className="font-bold">åˆè¨ˆ</span><span className="font-mono font-bold">${financials.companyFunds.toLocaleString()}</span></div></div></div></td></tr>); })}</tbody><tfoot className="bg-gray-100 font-bold border-t-2 border-gray-300"><tr><td colSpan={5} className="px-6 py-4 text-right">ç¸½è¨ˆ</td><td className="px-6 py-4 text-right text-green-700 bg-green-100">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).deptBonus,0)).toLocaleString()}</td><td className="px-6 py-4 text-right text-purple-700 bg-purple-100">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).companyFunds,0)).toLocaleString()}</td></tr></tfoot></table></div></div><div className="flex justify-between pt-6"><button onClick={() => setStep(3)} className="text-gray-500 hover:text-gray-900">ä¸Šä¸€æ­¥</button><button onClick={() => setStep(5)} className="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md flex items-center font-bold">ä¸‹ä¸€æ­¥ï¼šè‚¡æ±åˆ†ç´… <span className="ml-2">â¡ï¸</span></button></div></div>)}
                                        {step === 5 && (<div className="space-y-6 animate-in fade-in slide-in-from-bottom-4"><div className="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 p-6 rounded-xl flex flex-col items-center"><h3 className="text-lg font-medium text-purple-800 mb-2">æœ¬æ¬¡å¯åˆ†ç´…é‡‘é¡ (è³‡é‡‘æ±  15%)</h3><div className="text-4xl font-extrabold text-purple-600 tracking-tight">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.15).toLocaleString()}</div></div>{shareholders.length === 0 && (<div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4"><div className="flex"><span className="mr-3 text-xl">â„¹ï¸</span><div className="ml-3"><p className="text-sm text-blue-700 font-bold">ç›®å‰ç„¡è‚¡æ±è³‡æ–™ï¼Œè«‹å‰å¾€ã€Œè‚¡æ±ç®¡ç†ã€åŒ¯å…¥ã€‚</p></div></div></div>)}<div className="bg-white border rounded-xl shadow-sm overflow-hidden"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left font-medium text-gray-500">è‚¡æ±å§“å</th><th className="px-6 py-3 text-left font-medium text-gray-500">è·ç¨±</th><th className="px-6 py-3 text-right font-medium text-gray-500">æŠ•è³‡è‚¡æ•¸</th><th className="px-6 py-3 text-right font-medium text-gray-500">åˆ†ç´…ä½”æ¯”</th><th className="px-6 py-3 text-right font-bold text-gray-800">æ‡‰é ˜åˆ†ç´…</th></tr></thead><tbody className="divide-y divide-gray-200">{shareholders.map(s => { const pool = Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+calculateFinancials(r).turnover,0)*0.15); const ratio = parseFloat(s.ratio) || 0; return (<tr key={s.id} className="hover:bg-gray-50"><td className="px-6 py-4 font-medium text-gray-900"><button onClick={() => setViewingShareholderDetail(s)} className="text-blue-600 hover:text-blue-800 hover:underline flex items-center"><span className="mr-2">ğŸ‘ï¸</span>{s.name}</button></td><td className="px-6 py-4 text-gray-500">{s.role}</td><td className="px-6 py-4 text-right">{s.shares}</td><td className="px-6 py-4 text-right font-mono text-blue-600">{ratio}%</td><td className="px-6 py-4 text-right font-bold text-green-600">${Math.round(pool * (ratio/100)).toLocaleString()}</td></tr>); })}</tbody></table></div><div className="flex justify-between pt-6"><button onClick={() => setStep(4)} className="text-gray-500 hover:text-gray-900">ä¸Šä¸€æ­¥</button><button onClick={saveToDatabase} disabled={loading} className="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-md flex items-center font-bold disabled:opacity-50 disabled:cursor-not-allowed">{loading ? 'å„²å­˜ä¸­...' : 'ç¢ºèªçµç®—'} <span className="ml-2">ğŸ’¾</span></button></div></div>)}
                                        {step === 6 && (<div className="text-center py-20 animate-in zoom-in"><span className="text-6xl mb-4 block">âœ…</span><h2 className="text-3xl font-bold text-gray-900 mb-2">è¨ˆç®—å®Œæˆï¼</h2><p className="text-gray-500 mb-8">æ‰€æœ‰æ•¸æ“šå·²è¨ˆç®—å®Œç•¢ã€‚è«‹å‰å¾€ã€Œéƒ¨é–€å ±è¡¨ã€æˆ–ã€Œè‚¡æ±ç®¡ç†ã€æŸ¥çœ‹/åˆ—å°å ±è¡¨ã€‚<br/>é‡æ–°æ•´ç†é é¢å¾Œï¼Œæ‰€æœ‰è³‡æ–™å°‡æœƒæ¶ˆå¤±ã€‚</p>
                                        <div className="flex justify-center gap-4 flex-wrap">
                                            <button onClick={handleBackupZip} className="px-8 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium shadow-lg flex items-center"><span className="mr-2">ğŸ“¦</span> ä¸‹è¼‰åŸå§‹å‚™ä»½ (JSON/Excel)</button>
                                            <button onClick={handleDownloadAllImages} disabled={imgProcessing} className="px-8 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium shadow-lg flex items-center disabled:opacity-50 disabled:cursor-not-allowed"><span className="mr-2">{imgProcessing ? 'â³' : 'ğŸ–¼ï¸'}</span> {imgProcessing ? 'æ­£åœ¨ç¹ªè£½å ±è¡¨...' : 'ä¸‹è¼‰æ‰€æœ‰å ±è¡¨ (JPG)'}</button>
                                            <button onClick={() => {setStep(1); setMergedData([]); setFileName('');}} className="px-8 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-medium">è™•ç†ä¸‹ä¸€ä»½</button>
                                        </div></div>)}
                                    </div>
                                </div>
                            )}

                            {viewingShareholderDetail && (<div className="fixed inset-0 z-[100] bg-gray-500 bg-opacity-75 flex items-center justify-center p-4"><div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 animate-in zoom-in-95 flex flex-col max-h-[80vh]"><div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="text-lg font-bold text-gray-900">åˆ†ç´…æ˜ç´°: <span className="text-blue-600">{viewingShareholderDetail.name}</span></h3><button onClick={() => setViewingShareholderDetail(null)} className="text-gray-400 hover:text-gray-600">âŒ</button></div><div className="flex-1 overflow-auto"><table className="min-w-full divide-y divide-gray-200 text-sm"><thead className="bg-gray-50 sticky top-0"><tr><th className="px-4 py-2 text-left">æ—¥æœŸ</th><th className="px-4 py-2 text-left">ä»»å‹™ç·¨è™Ÿ</th><th className="px-4 py-2 text-left">ä»»å‹™åˆ†é¡</th><th className="px-4 py-2 text-right">è©²æ¡ˆç‡Ÿæ¥­é¡</th><th className="px-4 py-2 text-right">åˆ†ç´…è³‡é‡‘æ± (15%)</th><th className="px-4 py-2 text-right">å€‹äººåˆ†ç´…({viewingShareholderDetail.ratio}%)</th></tr></thead><tbody className="divide-y divide-gray-200">{mergedData.filter(r => r.selected && !r.isDuplicate).map(row => { const financials = calculateFinancials(row); const pool = Math.round(financials.turnover * BONUS_RATIOS.dividends); const share = Math.round(pool * (parseFloat(viewingShareholderDetail.ratio)/100)); return (<tr key={row.id}><td className="px-4 py-2 text-gray-500">{row.date}</td><td className="px-4 py-2 font-mono text-xs">{row.id}</td><td className="px-4 py-2">{row.category}</td><td className="px-4 py-2 text-right">${financials.turnover.toLocaleString()}</td><td className="px-4 py-2 text-right text-gray-500">${pool.toLocaleString()}</td><td className="px-4 py-2 text-right font-bold text-green-600">${share.toLocaleString()}</td></tr>); })}</tbody><tfoot className="bg-gray-100 font-bold sticky bottom-0"><tr><td colSpan={5} className="px-4 py-2 text-right">ç¸½è¨ˆ</td><td className="px-4 py-2 text-right text-green-700">${Math.round(mergedData.filter(r=>r.selected&&!r.isDuplicate).reduce((acc,r)=>acc+(calculateFinancials(r).turnover * BONUS_RATIOS.dividends),0) * (parseFloat(viewingShareholderDetail.ratio)/100)).toLocaleString()}</td></tr></tfoot></table></div></div></div>)}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
